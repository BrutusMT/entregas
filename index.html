<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rota Priorit√°ria ‚Äì App de Entregas</title>

<style>
:root{
    --bg:#121212;
    --card:#1e1e1e;
    --header:#1f1f1f;
    --alta:#b71c1c;
    --media:#f57f17;
    --baixa:#1b5e20;
    --ok:#4caf50;
}
body{
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background:var(--bg);
    color:#fff;
}
header{
    background:var(--header);
    padding:15px;
    text-align:center;
    font-size:20px;
    font-weight:bold;
}
.container{ padding:15px; }

.section{
    background:var(--card);
    padding:15px;
    border-radius:8px;
    margin-bottom:20px;
}

input, select, button{
    width:100%;
    padding:10px;
    margin-top:10px;
    border:none;
    border-radius:5px;
}
button{
    background:var(--ok);
    color:#fff;
    font-weight:bold;
    cursor:pointer;
}

.cards{ display:flex; flex-direction:column; gap:10px; }

.card{ padding:15px; border-radius:8px; }
.prioridade-alta{ background:var(--alta); }
.prioridade-media{ background:var(--media); }
.prioridade-baixa{ background:var(--baixa); }

.card small{ opacity:0.8; }

.card button{ background:#000; margin-top:10px; }

#map{ width:100%; height:280px; border-radius:8px; border:none; }

.status{ font-size:12px; margin-top:5px; }

.filtros{ display:flex; gap:5px; }
.filtros button{ background:#333; }

/* MODAL */
.modal{
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,.8);
    align-items:center;
    justify-content:center;
    z-index:10;
}
.modal-content{
    background:#1e1e1e;
    width:90%; max-height:80%;
    overflow-y:auto;
    padding:15px;
    border-radius:8px;
}
.modal-content h3{ margin-top:0; }
</style>
</head>
<body>

<header>üöö Rota Priorit√°ria ‚Äì Entregador</header>

<div class="container">

<div class="section">
    <h3>‚ûï Nova Entrega</h3>
    <form id="formEntrega">
        <input type="text" id="nome" placeholder="Nome do cliente" required>
        <input type="text" id="endereco" placeholder="Endere√ßo completo" required>
        <select id="prioridade">
            <option value="3">Alta prioridade</option>
            <option value="2">M√©dia prioridade</option>
            <option value="1">Baixa prioridade</option>
        </select>
        <button type="submit">Adicionar Entrega</button>
    </form>
</div>

<div class="section filtros">
    <button onclick="filtrar('todas')">Todas</button>
    <button onclick="filtrar(3)">Alta</button>
    <button onclick="filtrar(2)">M√©dia</button>
    <button onclick="filtrar(1)">Baixa</button>
</div>

<div class="cards" id="listaEntregas"></div>

<div class="section">
    <h3>üì¶ Entregas Conclu√≠das</h3>
    <button onclick="abrirHistorico()">Ver Hist√≥rico</button>
</div>

<div class="section">
    <h3>üó∫Ô∏è Mapa da Rota</h3>
    <iframe id="map" loading="lazy"></iframe>
</div>

</div>

<!-- MODAL HIST√ìRICO -->
<div class="modal" id="modalHistorico">
    <div class="modal-content">
        <h3>üìú Hist√≥rico de Entregas</h3>
        <div id="listaHistorico"></div>
        <button onclick="fecharHistorico()">Fechar</button>
    </div>
</div>

<script>
let entregas = JSON.parse(localStorage.getItem('entregas')) || [];
let historico = JSON.parse(localStorage.getItem('historico')) || [];
let localAtual = null;
let filtroAtual = 'todas';

navigator.geolocation.getCurrentPosition(pos => {
    localAtual = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    atualizarLista();
});

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function filtrar(p){ filtroAtual = p; atualizarLista(); }

function atualizarLista(){
    const lista = document.getElementById('listaEntregas');
    lista.innerHTML = '';
    let dados = filtroAtual==='todas' ? entregas : entregas.filter(e=>e.prioridade==filtroAtual);
    dados.sort((a,b)=> b.score - a.score);
    dados.forEach((e,i)=>{
        const classe = e.prioridade==3?'prioridade-alta':e.prioridade==2?'prioridade-media':'prioridade-baixa';
        const card = document.createElement('div');
        card.className = `card ${classe}`;
        card.innerHTML = `
            <strong>${e.nome}</strong><br>
            <small>${e.endereco}</small><br>
            üìç ${e.distancia ? e.distancia.toFixed(2)+' km':'--'}
            <div class="status">Status: ${e.status}</div>
            <button onclick="abrirMapa('${e.endereco}')">Iniciar rota</button>
            <button onclick="finalizar(${i})">Marcar como entregue</button>`;
        lista.appendChild(card);
    });
}

function abrirMapa(endereco){
    document.getElementById('map').src = `https://www.google.com/maps?q=${encodeURIComponent(endereco)}&output=embed`;
}

function finalizar(i){
    const entrega = entregas[i];
    entrega.status = 'Entregue';
    entrega.data = new Date().toLocaleString();
    historico.push(entrega);
    entregas.splice(i,1);
    localStorage.setItem('entregas', JSON.stringify(entregas));
    localStorage.setItem('historico', JSON.stringify(historico));
    atualizarLista();
}

function abrirHistorico(){
    const modal = document.getElementById('modalHistorico');
    const lista = document.getElementById('listaHistorico');
    lista.innerHTML = '';
    historico.forEach(e=>{
        const div = document.createElement('div');
        div.className='section';
        div.innerHTML = `<strong>${e.nome}</strong><br>${e.endereco}<br><small>${e.data}</small>`;
        lista.appendChild(div);
    });
    modal.style.display='flex';
}

function fecharHistorico(){
    document.getElementById('modalHistorico').style.display='none';
}

const form = document.getElementById('formEntrega');
form.addEventListener('submit', async e => {
    e.preventDefault();
    const nome = document.getElementById('nome').value;
    const endereco = document.getElementById('endereco').value;
    const prioridade = parseInt(document.getElementById('prioridade').value);
    let distancia = null;
    if(localAtual){
        try{
            const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`);
            const data = await geo.json();
            if(data[0]) distancia = calcularDistancia(localAtual.lat, localAtual.lng, data[0].lat, data[0].lon);
        }catch{}
    }
    const score = (distancia ? (10 - distancia) : 0) + prioridade * 2;
    entregas.push({ nome, endereco, prioridade, distancia, score, status:'Pendente' });
    localStorage.setItem('entregas', JSON.stringify(entregas));
    form.reset();
    atualizarLista();
});

atualizarLista();
</script>
</body>
</html>
