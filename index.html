<!DOCTYPE html><html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rota PrioritÃ¡ria â€“ App de Entregas</title>
<style>
:root{--bg:#121212;--card:#1e1e1e;--header:#1f1f1f;--alta:#b71c1c;--media:#f57f17;--baixa:#1b5e20;--ok:#4caf50}
body{margin:0;font-family:Arial;background:var(--bg);color:#fff}
header{background:var(--header);padding:15px;text-align:center;font-size:20px;font-weight:bold}
.container{padding:15px}
.section{background:var(--card);padding:15px;border-radius:8px;margin-bottom:20px}
input,select,button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px}
button{background:var(--ok);color:#fff;font-weight:bold;cursor:pointer}
.cards{display:flex;flex-direction:column;gap:10px}
.card{padding:15px;border-radius:8px}
.prioridade-alta{background:var(--alta)}
.prioridade-media{background:var(--media)}
.prioridade-baixa{background:var(--baixa)}
iframe{width:100%;height:280px;border:none;border-radius:8px}
.stats{display:flex;gap:10px;margin-bottom:15px}
.stat{flex:1;background:#000;padding:10px;border-radius:6px;text-align:center}
</style>
</head>
<body>
<header>ğŸšš Rota PrioritÃ¡ria â€“ Entregador</header>
<div class="container">
<div class="stats">
 <div class="stat">â³ Pendentes<br><strong id="pendentes">0</strong></div>
 <div class="stat">ğŸ“¦ Remessas<br><strong id="totalRemessas">0</strong></div>
</div>
<div class="section">
 <h3>ğŸ“¦ Abertura de Remessa</h3>
 <button onclick="abrirRemessa()">Abrir nova remessa</button>
 <div id="remessaAtiva"></div>
</div>
<div class="section">
 <h3>â• Nova Entrega</h3>
 <form id="formEntrega">
  <input id="nome" placeholder="Dono do pacote" required>
  <input id="endereco" placeholder="EndereÃ§o" list="sugestoesEnd" required>
  <datalist id="sugestoesEnd"></datalist>
  <input id="cep" placeholder="CEP" required>  <select id="prioridade">
   <option value="3">Alta</option>
   <option value="2">MÃ©dia</option>
   <option value="1">Baixa</option>
  </select>
  <button type="submit">Adicionar</button>
 </form>
</div>
<div class="cards" id="listaEntregas"></div>
<div class="section">
 <h3>ğŸ—ºï¸ Mapa da Rota</h3>
 <button onclick="iniciarJornadaMaps()">ğŸš€ Iniciar Jornada no Google Maps</button>
 <iframe id="mapa"></iframe>
</div>
<div class="section">
 <button onclick="finalizarRemessa()">âœ… Finalizar Remessa</button>
 <button onclick="gerarPDF()">ğŸ“„ Gerar RelatÃ³rio PDF</button>
</div>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script>
let entregas = JSON.parse(localStorage.getItem('entregasAtivas')) || [];
let selecionadas = [];
let remessas = JSON.parse(localStorage.getItem('remessas')) || [];
let remessaAtual = null;

// elementos DOM
const formEntrega = document.getElementById('formEntrega');
const nome = document.getElementById('nome');
const endereco = document.getElementById('endereco');
const cep = document.getElementById('cep');
const prioridade = document.getElementById('prioridade');
const scannerModal = document.getElementById('scannerModal');
const video = document.getElementById('video');
const mapa = document.getElementById('mapa');
let posicaoAtual=null;
let stream=null;

function obterLocalizacao(cb){
 navigator.geolocation.getCurrentPosition(p=>{
  posicaoAtual={lat:p.coords.latitude,lng:p.coords.longitude};
  if(cb)cb();
 },()=>alert('Permita o acesso Ã  localizaÃ§Ã£o'));
}

function abrirRemessa(){
 if(remessaAtual) return alert('JÃ¡ existe remessa aberta');
 remessaAtual = { inicio: new Date().toLocaleString(), entregas: [] };
 entregas = [];
 document.getElementById('remessaAtiva').innerHTML = 'ğŸŸ¢ Remessa iniciada em ' + remessaAtual.inicio;
 salvar();
}

formEntrega.onsubmit = e => {
 e.preventDefault();
 if(!remessaAtual) return alert('Abra uma remessa primeiro');
 if(!nome.value || !endereco.value || !cep.value) return alert('Preencha todos os campos');
 const nova = {
  nome: nome.value.trim(),
  endereco: endereco.value.trim(),
  cep: cep.value.trim(),
  prioridade: parseInt(prioridade.value,10)
 };
 entregas.push(nova);
 salvarSugestoes(nova.endereco);
 formEntrega.reset();
 salvar();
};
 entregas.push(nova);
 salvarSugestoes(nova.endereco);
 formEntrega.reset();
 salvar();
};

function atualizar(){
 pendentes.textContent=entregas.length;
 totalRemessas.textContent=remessas.length;
 listaEntregas.innerHTML='';
 entregas.forEach((e,i)=>{
  const d=document.createElement('div');
  d.className='card prioridade-'+(e.prioridade==3?'alta':e.prioridade==2?'media':'baixa');
  d.innerHTML=`<strong>${e.nome}</strong><br>${e.endereco}<br>CEP ${e.cep}<br>
  <button onclick="marcarEntregue(${i})">âœ… Entregue</button>
  <button onclick="marcarDevolvido(${i})">â†©ï¸ Devolvido</button>`;
  listaEntregas.appendChild(d);
 });
 atualizarMapa();
}

function iniciarJornadaMaps(){
 if(!entregas.length)return alert('Nenhuma entrega');
 obterLocalizacao(()=>{
  const origem=`${posicaoAtual.lat},${posicaoAtual.lng}`;
  const destinos=entregas.map(e=>encodeURIComponent(e.endereco+' '+e.cep)).join('/');
  window.open(`https://www.google.com/maps/dir/${origem}/${destinos}`,'_blank');
 });
}

function atualizarMapa(){
 if(!entregas.length||!posicaoAtual)return;
 const origem=`${posicaoAtual.lat},${posicaoAtual.lng}`;
 const destinos=entregas.map(e=>encodeURIComponent(e.endereco+' '+e.cep)).join('/');
 mapa.src=`https://www.google.com/maps/dir/${origem}/${destinos}?output=embed`;
}

function marcarEntregue(i){
 remessaAtual.entregas.push({...entregas[i],status:'ENTREGUE',data:new Date().toLocaleString()});
 entregas.splice(i,1);salvar();
}
function marcarDevolvido(i){
 remessaAtual.entregas.push({...entregas[i],status:'DEVOLVIDO',data:new Date().toLocaleString()});
 entregas.splice(i,1);salvar();
}

function finalizarRemessa(){
 if(!remessaAtual)return;
 remessaAtual.fim=new Date().toLocaleString();
 remessas.push(remessaAtual);
 remessaAtual=null;entregas=[];
 remessaAtiva.innerText='';salvar();
}

function gerarPDF(){
 const {jsPDF}=window.jspdf;const pdf=new jsPDF();let y=10;
 pdf.text('RelatÃ³rio de Remessas',10,y);y+=10;
 remessas.forEach((r,i)=>{
  pdf.text(`Remessa ${i+1}`,10,y);y+=6;
  pdf.text(`InÃ­cio: ${r.inicio}`,10,y);y+=6;
  pdf.text(`Fim: ${r.fim}`,10,y);y+=6;
  r.entregas.forEach(e=>{pdf.text(`- ${e.nome} | ${e.endereco} | ${e.status}`,12,y);y+=5;});
  y+=8;
 });
 pdf.save('relatorio_entregas.pdf');
}

function salvar(){
 localStorage.setItem('remessas',JSON.stringify(remessas));
 localStorage.setItem('entregasAtivas',JSON.stringify(entregas));
 atualizar();
}

function salvarSugestoes(v){
 const s=JSON.parse(localStorage.getItem('sugestoesEnd'))||[];
 if(!s.includes(v))s.push(v);
 localStorage.setItem('sugestoesEnd',JSON.stringify(s));
 carregarSugestoes();
}
function carregarSugestoes(){
 sugestoesEnd.innerHTML='';
 (JSON.parse(localStorage.getItem('sugestoesEnd'))||[]).forEach(v=>{const o=document.createElement('option');o.value=v;sugestoesEnd.appendChild(o);});
}

{scannerModal.style.display='none';if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}}

obterLocalizacao(()=>{carregarSugestoes();atualizar();});
</script></body>
</html>
