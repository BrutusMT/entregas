<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rota PrioritÃ¡ria â€“ Entregas</title>
<style>
:root{--bg:#121212;--card:#1e1e1e;--header:#1f1f1f;--alta:#b71c1c;--media:#f57f17;--baixa:#1b5e20;--ok:#4caf50}
body{margin:0;font-family:Arial;background:var(--bg);color:#fff}
header{background:var(--header);padding:15px;text-align:center;font-size:20px;font-weight:bold}
.container{padding:15px}
.section{background:var(--card);padding:15px;border-radius:8px;margin-bottom:20px}
input,select,button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px}
button{background:var(--ok);color:#fff;font-weight:bold;cursor:pointer}
.cards{display:flex;flex-direction:column;gap:10px}
.card{padding:15px;border-radius:8px}
.prioridade-alta{background:var(--alta)}
.prioridade-media{background:var(--media)}
.prioridade-baixa{background:var(--baixa)}
iframe{width:100%;height:280px;border:none;border-radius:8px}
.stats{display:flex;gap:10px;margin-bottom:15px}
.stat{flex:1;background:#000;padding:10px;border-radius:6px;text-align:center}
</style>
</head>
<body>
<header>ğŸšš Rota PrioritÃ¡ria â€“ App de Entregas</header>
<div class="container">

<div class="stats">
 <div class="stat">â³ Pendentes<br><strong id="pendentes">0</strong></div>
 <div class="stat">ğŸ“¦ Remessas<br><strong id="totalRemessas">0</strong></div>
</div>

<div class="section">
 <h3>ğŸ“¦ Abertura de Remessa</h3>
 <button id="btnAbrir">Abrir nova remessa</button>
 <div id="remessaAtiva"></div>
</div>

<div class="section">
 <h3>â• Nova Entrega</h3>
 <form id="formEntrega">
  <input id="nome" placeholder="Dono do pacote" required>
  <input id="endereco" placeholder="EndereÃ§o" required>
  <input id="cep" placeholder="CEP" required>
  <select id="prioridade">
   <option value="3">Alta</option>
   <option value="2">MÃ©dia</option>
   <option value="1">Baixa</option>
  </select>
  <button type="submit">Adicionar Entrega</button>
 </form>
</div>

<div class="cards" id="listaEntregas"></div>

<div class="section">
 <h3>ğŸ—ºï¸ Rota</h3>
 <button id="btnMaps">Abrir no Google Maps</button>
 <iframe id="mapa"></iframe>
</div>

<div class="section">
 <button id="btnFinalizar">Finalizar Remessa</button>
</div>

</div>

<!-- Modal de rota por entrega -->
<div id="modalRota" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:999;">
 <div style="background:#1e1e1e;margin:5% auto;padding:15px;border-radius:10px;max-width:500px;">
  <h3>ğŸ—ºï¸ Rota da entrega</h3>
  <iframe id="mapaEntrega" style="width:100%;height:300px;border:none;border-radius:8px"></iframe>
  <button onclick="abrirMapsExterno()">Abrir no Google Maps</button>
  <button onclick="fecharModal()" style="background:#555">Fechar</button>
 </div>
</div>

<script>
// ===== Estado =====
let entregas = JSON.parse(localStorage.getItem('entregasAtivas')) || [];
let remessas = JSON.parse(localStorage.getItem('remessas')) || [];
let remessaAtual = null;
let posicaoAtual = null;

// ===== DOM =====
const pendentes = document.getElementById('pendentes');
const totalRemessas = document.getElementById('totalRemessas');
const listaEntregas = document.getElementById('listaEntregas');
const remessaAtiva = document.getElementById('remessaAtiva');
const mapa = document.getElementById('mapa');

const formEntrega = document.getElementById('formEntrega');
const nome = document.getElementById('nome');
const endereco = document.getElementById('endereco');
const cep = document.getElementById('cep');
const prioridade = document.getElementById('prioridade');

// ===== LocalizaÃ§Ã£o (nÃ£o bloqueia o app) =====
function obterLocalizacao(cb){
 if(!navigator.geolocation){ if(cb)cb(); return; }
 navigator.geolocation.getCurrentPosition(
  p=>{ posicaoAtual={lat:p.coords.latitude,lng:p.coords.longitude}; if(cb)cb(); },
  ()=>{ if(cb)cb(); }
 );
}

// ===== Remessa =====
document.getElementById('btnAbrir').onclick = ()=>{
 if(remessaAtual){ alert('JÃ¡ existe remessa aberta'); return; }
 remessaAtual = { inicio:new Date().toLocaleString(), entregas:[] };
 entregas = [];
 remessaAtiva.innerText = 'ğŸŸ¢ Remessa iniciada em ' + remessaAtual.inicio;
 salvar();
};

// ===== Adicionar entrega =====
formEntrega.onsubmit = e =>{
 e.preventDefault();
 if(!remessaAtual){ alert('Abra uma remessa primeiro'); return; }
 const nova = { nome:nome.value, endereco:endereco.value, cep:cep.value, prioridade:+prioridade.value };
 entregas.push(nova);
 formEntrega.reset();
 salvar();
};

// ===== AtualizaÃ§Ã£o UI =====
function atualizar(){
 pendentes.innerText = entregas.length;
 totalRemessas.innerText = remessas.length;
 listaEntregas.innerHTML = '';
 entregas.forEach((e,i)=>{
  const d = document.createElement('div');
  d.className = 'card prioridade-'+(e.prioridade==3?'alta':e.prioridade==2?'media':'baixa');
  d.innerHTML = `<strong>${e.nome}</strong><br>${e.endereco}<br>CEP ${e.cep}<br>
  <button onclick="abrirRota(${i})">ğŸš— Iniciar corrida</button>
  <button onclick="entregar(${i})">âœ… Entregue</button>`;
  listaEntregas.appendChild(d);
 });
 atualizarMapa();
}

function entregar(i){
 remessaAtual.entregas.push({...entregas[i],status:'ENTREGUE'});
 entregas.splice(i,1);
 salvar();
}

let rotaAtual = null;

function abrirRota(i){
 obterLocalizacao(()=>{
  if(!posicaoAtual){ alert('LocalizaÃ§Ã£o indisponÃ­vel'); return; }
  const e = entregas[i];
  const origem = `${posicaoAtual.lat},${posicaoAtual.lng}`;
  const destino = encodeURIComponent(e.endereco+' '+e.cep);
  rotaAtual = `https://www.google.com/maps/dir/${origem}/${destino}`;
  document.getElementById('mapaEntrega').src = rotaAtual + '?output=embed';
  document.getElementById('modalRota').style.display='block';
 });
}

function abrirMapsExterno(){ if(rotaAtual) window.open(rotaAtual,'_blank'); }
function fecharModal(){ document.getElementById('modalRota').style.display='none'; }

// ===== Maps =====
document.getElementById('btnMaps').onclick = ()=>{
 if(!entregas.length){ alert('Sem entregas'); return; }
 obterLocalizacao(()=>{
  if(!posicaoAtual){ alert('LocalizaÃ§Ã£o indisponÃ­vel'); return; }
  const origem = `${posicaoAtual.lat},${posicaoAtual.lng}`;
  const destinos = entregas.map(e=>encodeURIComponent(e.endereco+' '+e.cep)).join('/');
  window.open(`https://www.google.com/maps/dir/${origem}/${destinos}`,'_blank');
 });
};

function atualizarMapa(){
 if(!posicaoAtual || !entregas.length) return;
 const origem = `${posicaoAtual.lat},${posicaoAtual.lng}`;
 const destinos = entregas.map(e=>encodeURIComponent(e.endereco+' '+e.cep)).join('/');
 mapa.src = `https://www.google.com/maps/dir/${origem}/${destinos}?output=embed`;
}

// ===== Finalizar =====
document.getElementById('btnFinalizar').onclick = ()=>{
 if(!remessaAtual) return;
 remessaAtual.fim = new Date().toLocaleString();
 remessas.push(remessaAtual);
 remessaAtual = null;
 entregas = [];
 remessaAtiva.innerText = '';
 salvar();
};

// ===== PersistÃªncia =====
function salvar(){
 localStorage.setItem('entregasAtivas',JSON.stringify(entregas));
 localStorage.setItem('remessas',JSON.stringify(remessas));
 atualizar();
}

obterLocalizacao(()=>{ atualizar(); });
</script>
</body>
</html>
