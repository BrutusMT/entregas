<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rota PrioritÃ¡ria â€“ Entregas</title>
<style>
:root{--bg:#121212;--card:#1e1e1e;--header:#1f1f1f;--alta:#b71c1c;--media:#f57f17;--baixa:#1b5e20;--ok:#4caf50}
body{margin:0;font-family:Arial;background:var(--bg);color:#fff}
header{background:var(--header);padding:15px;text-align:center;font-size:20px;font-weight:bold}
.container{padding:15px}
.section{background:var(--card);padding:15px;border-radius:8px;margin-bottom:20px}
input,select,button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px}
button{background:var(--ok);color:#fff;font-weight:bold;cursor:pointer}
.cards{display:flex;flex-direction:column;gap:10px}
.card{padding:15px;border-radius:8px}
.prioridade-alta{background:var(--alta)}
.prioridade-media{background:var(--media)}
.prioridade-baixa{background:var(--baixa)}
.stats{display:flex;gap:10px;margin-bottom:15px}
.stat{flex:1;background:#000;padding:10px;border-radius:6px;text-align:center}
.small{font-size:11px;opacity:.8}
a{color:#90caf9}
</style>
</head>
<body>
<header>ğŸšš Rota PrioritÃ¡ria â€“ App de Entregas</header>
<div class="container">

<div class="stats">
 <div class="stat">â³ Pendentes<br><strong id="pendentes">0</strong></div>
 <div class="stat">ğŸ“¦ Remessas Finalizadas<br><strong id="totalRemessas">0</strong></div>
</div>

<div class="section">
 <h3>ğŸ“¦ Abertura de Remessa</h3>
 <button id="btnAbrir">Abrir nova remessa</button>
 <button id="btnEditarRemessa" style="background:#f57f17">âœï¸ Editar remessa</button>
 <div id="remessaAtiva" class="small"></div>
</div>

<div class="section">
 <h3>â• Nova Entrega</h3>
 <form id="formEntrega">
  <input id="nome" placeholder="Dono do pacote" required>
  <input id="endereco" placeholder="EndereÃ§o" required>
  <input id="cep" placeholder="CEP (opcional)">
  <select id="prioridade">
   <option value="3">Alta</option>
   <option value="2">MÃ©dia</option>
   <option value="1">Baixa</option>
  </select>
  <button type="submit">Adicionar Entrega</button>
 </form>
</div>

<div class="cards" id="listaEntregas"></div>

<div class="section">
 <h3>ğŸ—ºï¸ Rotas & IA</h3>
 <div class="small">ğŸ¤– SugestÃ£o automÃ¡tica baseada em prioridade e proximidade estimada</div>
 <button id="btnSugestaoIA" style="background:#3f51b5">Sugerir prÃ³xima entrega</button>
 <div id="sugestoesIA" class="small" style="margin-top:10px"></div>
 <button id="btnMapsExterno" style="background:#607d8b">ğŸ§­ Abrir rota completa no Google Maps</button>
 <button id="btnReordenar" style="background:#455a64">ğŸ” Reordenar por prioridade</button>
</div>

<div class="section">
 <button id="btnImprimir">ğŸ–¨ï¸ Gerar PDF da Remessa</button>
 <button id="btnEscolherRemessa" style="background:#607d8b">ğŸ“‚ Escolher remessa</button>
 <button id="btnFinalizar">Finalizar Remessa</button>
 <button id="btnExcluirRemessa" style="background:#b71c1c">ğŸ—‘ï¸ Excluir Remessa</button>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ================= ESTADO =================
let entregas = JSON.parse(localStorage.getItem('entregasAtivas')) || [];
let remessas = JSON.parse(localStorage.getItem('remessas')) || [];
let remessaAtual = JSON.parse(localStorage.getItem('remessaAtual')) || null;
let posicaoAtual = null;
if(remessaAtual && !Array.isArray(remessaAtual.entregas)) remessaAtual.entregas = [];

// ================= DOM =================
const pendentes = document.getElementById('pendentes');
const totalRemessas = document.getElementById('totalRemessas');
const listaEntregas = document.getElementById('listaEntregas');
const remessaAtiva = document.getElementById('remessaAtiva');
const formEntrega = document.getElementById('formEntrega');
const nome = document.getElementById('nome');
const endereco = document.getElementById('endereco');
const cep = document.getElementById('cep');
const prioridade = document.getElementById('prioridade');

// ================= LOCALIZAÃ‡ÃƒO =================
function obterLocalizacao(cb){
 if(!navigator.geolocation){ cb&&cb(); return; }
 navigator.geolocation.getCurrentPosition(p=>{
  posicaoAtual={lat:p.coords.latitude,lng:p.coords.longitude};
  cb&&cb();
 },()=>cb&&cb());
}

// ================= REMESSA =================
document.getElementById('btnAbrir').onclick = ()=>{
 if(remessaAtual){ alert('JÃ¡ existe uma remessa aberta'); return; }
 const numero = remessas.length + 1;
 remessaAtual = { numero, inicio:new Date().toLocaleString(), entregas:[] };
 entregas = [];
 salvar();
};

document.getElementById('btnEditarRemessa').onclick = ()=>{
 if(!remessaAtual){ alert('Nenhuma remessa aberta'); return; }
 const novoNumero = prompt('Editar nÃºmero da remessa:', remessaAtual.numero);
 if(novoNumero && !isNaN(novoNumero)){
  remessaAtual.numero = Number(novoNumero);
  salvar();
 }
};

document.getElementById('btnFinalizar').onclick = ()=>{
 if(!remessaAtual) return;
 remessaAtual.fim = new Date().toLocaleString();
 remessas.push(remessaAtual);
 remessaAtual = null;
 entregas = [];
 salvar();
};

document.getElementById('btnExcluirRemessa').onclick = ()=>{
 if(remessaAtual && confirm('Excluir remessa atual?')){
  remessaAtual = null;
  entregas = [];
  salvar();
 }
};

// ================= ENTREGA =================
formEntrega.onsubmit = e =>{
 e.preventDefault();
 if(!remessaAtual){ alert('Abra uma remessa primeiro'); return; }
 entregas.push({ nome:nome.value, endereco:endereco.value, cep:cep.value||'', prioridade:+prioridade.value });
 formEntrega.reset();
 salvar();
};

function editarEntrega(i){
 const e = entregas[i];
 const novoEndereco = prompt('Editar endereÃ§o:', e.endereco);
 const novoCep = prompt('Editar CEP:', e.cep);
 if(novoEndereco!==null) e.endereco = novoEndereco;
 if(novoCep!==null) e.cep = novoCep;
 salvar();
}

function excluirEntrega(i){
 if(confirm('Excluir entrega?')){
  entregas.splice(i,1);
  salvar();
 }
}

function entregar(i){
 if(!remessaAtual) return;
 remessaAtual.entregas.push(entregas[i]);
 entregas.splice(i,1);
 salvar();
}

// ================= IA & MAPS =================
document.getElementById('btnSugestaoIA').onclick = ()=>{
 if(entregas.length===0){ alert('Nenhuma entrega pendente'); return; }
 const ordenadas = [...entregas].sort((a,b)=>{
  if(b.prioridade!==a.prioridade) return b.prioridade-a.prioridade;
  return a.endereco.length-b.endereco.length;
 });
 const div = document.getElementById('sugestoesIA');
 div.innerHTML = '<strong>PrÃ³ximas entregas sugeridas:</strong><br>';
 ordenadas.forEach((e,i)=>{
  const link = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.endereco)}`;
  div.innerHTML += `${i+1}. ${e.nome} â€“ <a href="${link}" target="_blank">${e.endereco}</a><br>`;
 });
};

document.getElementById('btnMapsExterno').onclick = ()=>{
 if(!posicaoAtual){ alert('LocalizaÃ§Ã£o atual nÃ£o disponÃ­vel'); return; }
 if(entregas.length===0){ alert('Nenhuma entrega'); return; }
 const waypoints = entregas.map(e=>encodeURIComponent(e.endereco)).join('|');
 const url = `https://www.google.com/maps/dir/?api=1&origin=${posicaoAtual.lat},${posicaoAtual.lng}&destination=${encodeURIComponent(entregas[entregas.length-1].endereco)}&waypoints=${waypoints}&travelmode=driving`;
 window.open(url,'_blank');
};

document.getElementById('btnReordenar').onclick = ()=>{
 if(entregas.length<2){ alert('Entregas insuficientes'); return; }
 entregas.sort((a,b)=>{
  if(b.prioridade!==a.prioridade) return b.prioridade-a.prioridade;
  return a.endereco.length-b.endereco.length;
 });
 salvar();
};

function abrirRotaEntregaExterna(i){
 if(!posicaoAtual){ alert('LocalizaÃ§Ã£o atual nÃ£o disponÃ­vel'); return; }
 const destino = encodeURIComponent(entregas[i].endereco);
 const url = `https://www.google.com/maps/dir/?api=1&origin=${posicaoAtual.lat},${posicaoAtual.lng}&destination=${destino}&travelmode=driving`;
 window.open(url,'_blank');
}

// ================= PDF =================
document.getElementById('btnImprimir').onclick = ()=>{
 if(!remessaAtual){ alert('Nenhuma remessa ativa'); return; }
 const opcao = prompt('Gerar PDF de: 1 - Entregues | 2 - NÃ£o entregues');
 if(opcao==='1') gerarPDF(remessaAtual,'entregues');
 else if(opcao==='2') gerarPDF(remessaAtual,'nao');
};

document.getElementById('btnEscolherRemessa').onclick = ()=>{
 if(remessas.length===0){ alert('Nenhuma remessa finalizada'); return; }
 const escolha = prompt('Digite o nÃºmero da remessa: ' + remessas.map(r=>r.numero).join(', '));
 const r = remessas.find(r=>r.numero==escolha);
 if(r) gerarPDF(r,'entregues');
};

function gerarPDF(r,tipo){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF({unit:'mm',format:'a4'});
 let y=10;
 doc.setFontSize(8);
 doc.text(`Remessa NÂº ${r.numero}`,10,y); y+=4;
 doc.text(`InÃ­cio: ${r.inicio}`,10,y); y+=4;
 if(r.fim){ doc.text(`Fim: ${r.fim}`,10,y); y+=4; }
 y+=2;
 let lista = [];
 if(tipo==='entregues') lista = r.entregas||[];
 if(tipo==='nao') lista = entregas||[];
 lista.forEach((e,i)=>{
  doc.text(`${i+1}. ${e.nome} - ${e.endereco}`,10,y);
  y+=4;
 });
 doc.save(`remessa_${r.numero}_${tipo}.pdf`);
}

// ================= UI =================
function atualizar(){
 pendentes.innerText = entregas.length;
 totalRemessas.innerText = remessas.length;
 listaEntregas.innerHTML='';
 remessaAtiva.innerText = remessaAtual ? `Remessa NÂº ${remessaAtual.numero} aberta` : 'Nenhuma remessa aberta';
 entregas.forEach((e,i)=>{
  const d=document.createElement('div');
  d.className='card prioridade-'+(e.prioridade==3?'alta':e.prioridade==2?'media':'baixa');
  d.innerHTML=`<strong>${i+1}. ${e.nome}</strong><br>${e.endereco}<br>CEP ${e.cep||'-'}<br>
  <button onclick="editarEntrega(${i})">Editar</button>
  <button onclick="abrirRotaEntregaExterna(${i})" style="background:#455a64">Maps</button>
  <button onclick="excluirEntrega(${i})" style="background:#b71c1c">Excluir</button>
  <button onclick="entregar(${i})">Entregue</button>`;
  listaEntregas.appendChild(d);
 });
}

// ================= PERSISTÃŠNCIA =================
function salvar(){
 localStorage.setItem('entregasAtivas',JSON.stringify(entregas));
 localStorage.setItem('remessas',JSON.stringify(remessas));
 localStorage.setItem('remessaAtual',JSON.stringify(remessaAtual));
 atualizar();
}

obterLocalizacao(()=>atualizar());
</script>
</body>
</html>
