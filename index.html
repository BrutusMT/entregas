<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rota PrioritÃ¡ria â€“ App de Entregas</title>

<style>
:root{
    --bg:#121212;--card:#1e1e1e;--header:#1f1f1f;
    --alta:#b71c1c;--media:#f57f17;--baixa:#1b5e20;
    --ok:#4caf50;--edit:#1976d2;--del:#c62828;--info:#455a64;
}
body{margin:0;font-family:Arial;background:var(--bg);color:#fff}
header{background:var(--header);padding:15px;text-align:center;font-size:20px;font-weight:bold}
.container{padding:15px}
.section{background:var(--card);padding:15px;border-radius:8px;margin-bottom:20px}
input,select,button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px}
button{background:var(--ok);color:#fff;font-weight:bold;cursor:pointer}
.cards{display:flex;flex-direction:column;gap:10px}
.card{padding:15px;border-radius:8px;position:relative}
.prioridade-alta{background:var(--alta)}
.prioridade-media{background:var(--media)}
.prioridade-baixa{background:var(--baixa)}
.actions{position:absolute;top:10px;right:10px;display:flex;gap:5px}
.actions button{width:auto;padding:5px 8px;font-size:12px}
.btn-edit{background:var(--edit)}
.btn-del{background:var(--del)}
.btn-info{background:var(--info)}
iframe{width:100%;height:280px;border:none;border-radius:8px}
.stats{display:flex;gap:10px;margin-bottom:15px}
.stat{flex:1;background:#000;padding:10px;border-radius:6px;text-align:center}
</style>
</head>
<body>
<header>ğŸšš Rota PrioritÃ¡ria â€“ Entregador</header>
<div class="container">

<div class="stats">
  <div class="stat">â³ Pendentes<br><strong id="pendentes">0</strong></div>
  <div class="stat">ğŸ“¦ Remessas<br><strong id="totalRemessas">0</strong></div>
</div>

<div class="section">
  <h3>ğŸ“¦ Abertura de Remessa</h3>
  <button onclick="abrirRemessa()">Abrir nova remessa</button>
  <div id="remessaAtiva"></div>
</div>

<div class="section">
  <h3>â• Nova Entrega</h3>
  <form id="formEntrega">
    <input id="nome" placeholder="Cliente" required>
    <input id="endereco" placeholder="EndereÃ§o" required>
    <input id="cep" placeholder="CEP" required>
    <select id="prioridade">
      <option value="3">Alta</option>
      <option value="2">MÃ©dia</option>
      <option value="1">Baixa</option>
    </select>
    <button type="submit">Adicionar</button>
  </form>
</div>

<div class="section">
  <h3>ğŸ Corrida</h3>
  <button onclick="iniciarCorrida()">â–¶ï¸ Iniciar Corrida</button>
  <button onclick="finalizarCorrida()">â¹ï¸ Finalizar Corrida</button>
</div>

<div class="cards" id="listaEntregas"></div>

<div class="section">
  <h3>ğŸ—ºï¸ Mapa da Rota</h3>
  <iframe id="mapa"></iframe>
</div>

<div class="section">
  <button onclick="finalizarRemessa()">âœ… Finalizar Remessa</button>
  <button onclick="gerarPDF()">ğŸ“„ Gerar RelatÃ³rio PDF</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let entregas=[];
let remessas=JSON.parse(localStorage.getItem('remessas'))||[];
let remessaAtual=null;
let posicaoAtual=null;
let corridaAtiva=false;

navigator.geolocation?.getCurrentPosition(p=>{
  posicaoAtual={lat:p.coords.latitude,lng:p.coords.longitude};
  atualizar();
});

function abrirRemessa(){
  if(remessaAtual) return alert('JÃ¡ existe remessa aberta');
  remessaAtual={inicio:new Date().toLocaleString(),entregas:[]};
  document.getElementById('remessaAtiva').innerHTML='ğŸŸ¢ Remessa iniciada em '+remessaAtual.inicio;
}

function calcularDistancia(lat1,lon1,lat2,lon2){
 const R=6371;
 const dLat=(lat2-lat1)*Math.PI/180;
 const dLon=(lon2-lon1)*Math.PI/180;
 const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
 return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function ordenarPorDistancia(){
 entregas.forEach(e=>{
  if(typeof e.distancia!=="number"){
    e.distancia=posicaoAtual ? Math.random()*10 : 0;
  }
 });
 entregas.sort((a,b)=>a.distancia-b.distancia);
}

function atualizar(){
 document.getElementById('pendentes').textContent=entregas.length;
 document.getElementById('totalRemessas').textContent=remessas.length;
 ordenarPorDistancia();
 const lista=document.getElementById('listaEntregas');
 lista.innerHTML='';
 entregas.forEach((e,i)=>{
  const dist=typeof e.distancia==='number' ? e.distancia.toFixed(2) : '0.00';
  const div=document.createElement('div');
  div.className='card prioridade-'+(e.prioridade==3?'alta':e.prioridade==2?'media':'baixa');
  div.innerHTML=`<strong>${e.nome}</strong><br>${e.endereco}<br>CEP ${e.cep}<br>ğŸ“ ${dist} km<br>
  <button onclick=\"iniciarRota(${i})\">ğŸ§­ Iniciar Rota</button>
  <button onclick=\"marcarEntregue(${i})\">âœ… Entregue</button>
  <button onclick=\"marcarDevolvido(${i})\">â†©ï¸ Devolvido</button>`;
  lista.appendChild(div);
 });
 atualizarMapa();
}

formEntrega.onsubmit=e=>{
 e.preventDefault();
 if(!remessaAtual) return alert('Abra uma remessa');
 entregas.push({
  nome:nome.value,
  endereco:endereco.value,
  cep:cep.value,
  prioridade:parseInt(prioridade.value,10),
  distancia:0
 });
 formEntrega.reset();
 atualizar();
};

function iniciarCorrida(){
 if(entregas.length===0) return alert('Sem entregas');
 corridaAtiva=true;alert('Corrida iniciada');
}

function finalizarCorrida(){
 corridaAtiva=false;alert('Corrida finalizada');
}

function atualizarMapa(){
 if(entregas.length===0) return;
 const origem=posicaoAtual?`${posicaoAtual.lat},${posicaoAtual.lng}`:'';
 const destinos=entregas.map(e=>encodeURIComponent(e.endereco+' '+e.cep)).join('/');
 document.getElementById('mapa').src='https://www.google.com/maps/dir/'+origem+'/'+destinos+'?travelmode=driving&output=embed';
}

function iniciarRota(i){
 const e=entregas[i];
 const url='https://www.google.com/maps/dir/?api=1&destination='+encodeURIComponent(e.endereco+' '+e.cep)+'&travelmode=driving';
 window.open(url,'_blank');
}

function marcarEntregue(i){
 if(!corridaAtiva) return alert('Inicie a corrida primeiro');
 const e=entregas[i];
 if(!remessaAtual) return;
 remessaAtual.entregas.push({...e,status:'ENTREGUE',data:new Date().toLocaleString()});
 entregas.splice(i,1);
 atualizar();
}

function marcarDevolvido(i){
 if(!corridaAtiva) return alert('Inicie a corrida primeiro');
 const e=entregas[i];
 if(!remessaAtual) return;
 remessaAtual.entregas.push({...e,status:'DEVOLVIDO',data:new Date().toLocaleString()});
 entregas.splice(i,1);
 atualizar();
}

function finalizarRemessa(){
 if(!remessaAtual) return;
 remessaAtual.fim=new Date().toLocaleString();
 remessaAtual.entregas=[...entregas];
 remessas.push(remessaAtual);
 entregas=[];
 remessaAtual=null;
 document.getElementById('remessaAtiva').innerHTML='';
 salvar();
}

function gerarPDF(){
 const {jsPDF}=window.jspdf;
 const pdf=new jsPDF();
 let y=10;
 pdf.text('RelatÃ³rio de Remessas',10,y);y+=10;
 remessas.forEach((r,i)=>{
  pdf.text(`Remessa ${i+1}`,10,y);y+=6;
  pdf.text(`InÃ­cio: ${r.inicio}`,10,y);y+=6;
  pdf.text(`Fim: ${r.fim||'-'}`,10,y);y+=6;
  const entregues=r.entregas||[];
  pdf.text(`Total de registros: ${entregues.length}`,10,y);y+=6;
  entregues.forEach((e,idx)=>{
    pdf.text(`- ${e.nome} (${e.status})`,12,y);
    y+=5;
    if(y>280){pdf.addPage();y=10;}
  });
  y+=8;
  if(y>280){pdf.addPage();y=10;}
 });
 pdf.save('relatorio_entregas.pdf');
}

function salvar(){
 localStorage.setItem('remessas',JSON.stringify(remessas));
 atualizar();
}

atualizar();
</script>
</body>
</html>
